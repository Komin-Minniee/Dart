<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EMS ‚Äì bank on page, builder in popup</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            background: #eef2f7;
        }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .app-container {
            width: 1400px;
            max-width: 98vw;
            height: 96vh;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ===== HEADER ===== */
        .ems-header {
            background: linear-gradient(135deg, #0a2a5e 0%, #123e7c 100%);
            border-radius: 50px;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 12px 24px rgba(0, 25, 70, 0.4);
            flex-shrink: 0;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .ems-icon {
            background: #ffcd6b;
            border-radius: 50px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .ems-title h1 {
            color: white;
            font-size: 1.7rem;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        .ems-title .sub {
            color: #b6d0f0;
            font-size: 0.85rem;
        }
        .header-right {
            background: rgba(255,255,255,0.15);
            padding: 8px 24px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .create-btn, .import-btn {
            border: none;
            font-weight: 700;
            padding: 8px 22px;
            border-radius: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: 0.1s;
        }
        .create-btn {
            background: #ffcd6b;
            color: #0a2a5e;
        }
        .create-btn:hover {
            background: #ffdb8e;
        }
        .import-btn {
            background: #ffffff;
            color: #0a2a5e;
        }
        .import-btn:hover {
            background: #eef5ff;
        }

        /* ===== QUESTION BANK (full page) ===== */
        .bank-fullpage {
            background: white;
            border-radius: 40px;
            box-shadow: 0 18px 36px -12px rgba(0, 25, 60, 0.25);
            display: flex;
            flex-direction: column;
            padding: 24px 32px;
            flex: 1;
            overflow: hidden;
        }

        .bank-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .bank-header h2 {
            font-size: 1.8rem;
            font-weight: 650;
            color: #0b2f66;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .count-badge {
            background: #e2eaf8;
            color: #1f3f77;
            border-radius: 60px;
            padding: 8px 24px;
            font-weight: 700;
            font-size: 1rem;
        }

        .bank-scroll {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
        }

        /* expandable bank items */
        .bank-item {
            background: #f5faff;
            border-radius: 48px;
            padding: 16px 24px;
            margin-bottom: 18px;
            border-left: 8px solid #1e4a8b;
            transition: 0.1s;
        }
        .bank-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .bank-question-preview {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0a2a5e;
            flex: 1;
        }
        .expand-icon {
            font-size: 1.6rem;
            color: #1e4a8b;
            margin-right: 16px;
        }
        .bank-actions {
            display: flex;
            gap: 8px;
        }
        .bank-action-btn {
            background: white;
            border: 1px solid #b5cbe3;
            border-radius: 40px;
            padding: 6px 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .bank-action-btn.edit:hover {
            background: #e0edff;
        }
        .bank-action-btn.delete:hover {
            background: #ffe8e8;
            border-color: #dc8686;
        }

        .bank-detail {
            margin-top: 20px;
            padding-top: 14px;
            border-top: 2px dashed #c7d9f0;
        }
        .bank-full-question {
            font-size: 1.1rem;
            background: white;
            border-radius: 40px;
            padding: 16px 24px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        .bank-options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            margin: 16px 0;
        }
        .bank-option {
            background: white;
            border-radius: 40px;
            padding: 12px 22px;
            border: 1px solid #c7d9f0;
            font-size: 1rem;
        }
        .bank-option.correct {
            background: #e6ffed;
            border-color: #1e8f4a;
            font-weight: 600;
        }
        .bank-option.correct::after {
            content: " ‚úì";
            color: #1e8f4a;
        }
        .bank-meta {
            display: flex;
            gap: 20px;
            font-size: 0.95rem;
            color: #2f4b78;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        .bank-meta span {
            background: #e2eaf8;
            padding: 4px 20px;
            border-radius: 40px;
        }

        .empty-placeholder {
            background: #f2f6fd;
            border-radius: 60px;
            padding: 40px;
            text-align: center;
            color: #5d7aa5;
            font-size: 1.2rem;
        }

        /* ===== MODAL (question builder) ===== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 20, 50, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-card {
            background: white;
            border-radius: 60px;
            width: 900px;
            max-width: 95vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            padding: 32px 40px;
            box-shadow: 0 50px 80px rgba(0, 25, 70, 0.6);
        }
        .modal-card h3 {
            font-size: 2rem;
            font-weight: 650;
            color: #0b2f66;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .builder-scroll {
            overflow-y: auto;
            padding-right: 8px;
            flex: 1;
        }

        .field-row {
            display: flex;
            gap: 16px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .field {
            display: flex;
            flex-direction: column;
            flex: 1 1 160px;
        }
        .field label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #4d6587;
            margin-bottom: 4px;
        }
        input, select, textarea {
            background: #f9fcff;
            border: 1.5px solid #dbe3f0;
            border-radius: 40px;
            padding: 9px 18px;
            font-size: 0.95rem;
            outline: none;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #1e4a8b;
            box-shadow: 0 0 0 3px rgba(30,74,139,0.15);
        }

        .question-preview {
            background: #f2f7ff;
            border: 1px dashed #8ba5cf;
            border-radius: 40px;
            padding: 12px 20px;
            font-size: 1rem;
            color: #1d3a5e;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 48px;
            display: flex;
            align-items: center;
        }
        .question-preview:hover {
            background: #e5f0ff;
            border-color: #1e4a8b;
        }
        .hidden-textarea {
            display: none;
        }

        .options-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #11355e;
            margin: 18px 0 12px 0;
        }
        .options-grid {
            background: #f5f9ff;
            border-radius: 40px;
            padding: 20px 24px;
        }
        .option-row {
            display: flex;
            align-items: center;
            gap: 14px;
            background: white;
            border-radius: 50px;
            border: 1px solid #dfe8f3;
            padding: 8px 20px 8px 14px;
            margin-bottom: 12px;
        }
        .opt-index {
            background: #dde5f2;
            color: #1e3f72;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 40px;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .opt-preview {
            flex: 1;
            background: #f2f7ff;
            border: 1px dashed #8ba5cf;
            border-radius: 40px;
            padding: 10px 18px;
            font-size: 0.95rem;
            color: #1d3a5e;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .opt-preview:hover {
            background: #e5f0ff;
            border-color: #1e4a8b;
        }
        .correct-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #eaf1fb;
            padding: 5px 18px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1f3f77;
            flex-shrink: 0;
        }
        .correct-toggle input {
            width: auto;
            margin: 0;
            accent-color: #1e4a8b;
        }

        .btn-save {
            background: #0b2f66;
            color: white;
            border: none;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 14px 36px;
            border-radius: 60px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(11,47,102,0.4);
            margin: 20px 0 10px 0;
            width: 100%;
            justify-content: center;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 24px;
            flex-shrink: 0;
        }
        .modal-btn {
            border: none;
            padding: 12px 34px;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
        }
        .modal-btn.cancel {
            background: #eef2f7;
            color: #2f4b78;
        }
        .modal-btn.save {
            background: #0b2f66;
            color: white;
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">

        <!-- HEADER with CREATE button (opens builder modal) -->
        <header class="ems-header">
            <div class="header-left">
                <div class="ems-icon">üìã</div>
                <div class="ems-title">
                    <h1>Examination Management System</h1>
                    <div class="sub">EMS ¬∑ Question Bank</div>
                </div>
            </div>
            <div class="header-right">
                <span>üìÖ {{ currentDate }}</span>
                <button class="create-btn" @click="openBuilderModal">
                    <span>‚ûï</span> Create question
                </button>
                <button class="import-btn" @click="openImportModal">
                    <span>üì§</span> Import
                </button>
            </div>
        </header>

        <!-- QUESTION BANK (full page, expandable items) -->
        <div class="bank-fullpage">
            <div class="bank-header">
                <h2>üìö Question Bank <span class="count-badge">{{ questionList.length }} total</span></h2>
            </div>
            <div class="bank-scroll">
                <div v-if="questionList.length === 0" class="empty-placeholder">
                    No questions yet. Click "Create question" to add one.
                </div>
                <div v-for="(q, idx) in questionList" :key="idx" class="bank-item">
                    <div class="bank-item-header" @click="toggleExpand(idx)">
                        <span class="bank-question-preview">{{ idx+1 }}. {{ q.question_text.substring(0,80) }}{{ q.question_text.length > 80 ? '‚Ä¶' : '' }}</span>
                        <span class="expand-icon">{{ expandedIndex === idx ? '‚ñº' : '‚ñ∂' }}</span>
                        <div class="bank-actions" @click.stop>
                            <button class="bank-action-btn edit" @click="editFromBank(idx)">‚úé Edit</button>
                            <button class="bank-action-btn delete" @click="deleteFromBank(idx)">‚úï Delete</button>
                        </div>
                    </div>
                    <div v-if="expandedIndex === idx" class="bank-detail">
                        <div class="bank-full-question">{{ q.question_text }}</div>
                        <div class="bank-options-grid">
                            <div v-for="(opt, optIdx) in q.options" :key="optIdx" 
                                 class="bank-option" :class="{ correct: opt.is_correct === 1 }">
                                {{ String.fromCharCode(65 + optIdx) }}. {{ opt.text }}
                            </div>
                        </div>
                        <div class="bank-meta">
                            <span>Subject: {{ q.subject_code }} - {{ q.subject_name }}</span>
                            <span>Score: {{ q.score }}</span>
                            <span>Type: {{ q.question_type }}</span>
                            <span>Status: {{ q.question_status }}</span>
                            <span>Year: {{ q.year_id }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BUILDER MODAL (popup) -->
        <div v-if="builderModalActive" class="modal-overlay" @click.self="closeBuilderModal">
            <div class="modal-card">
                <h3><span>‚úèÔ∏è Create / Edit Question</span></h3>
                <div class="builder-scroll">
                    <form @submit.prevent="submitForm">
                        <div class="field-row">
                            <div class="field"><label>Code</label><input type="text" v-model="form.subject_code" placeholder="CS101" required></div>
                            <div class="field"><label>Name</label><input type="text" v-model="form.subject_name" placeholder="Intro to CS" required></div>
                            <div class="field"><label>Status</label><select v-model="form.subject_status"><option value="draft">draft</option><option value="active">active</option><option value="inactive">inactive</option><option value="archived">archived</option></select></div>
                        </div>
                        <div class="field-row">
                            <div class="field" style="max-width:200px;"><label>Year</label><select v-model="form.year_id"><option value="1">2024-2025</option><option value="2">2025-2026</option></select></div>
                        </div>

                        <!-- QUESTION preview (clickable) -->
                        <div class="field">
                            <label>Question (click to edit)</label>
                            <div class="question-preview" :class="{ empty: !form.question_text }" @click="openQuestionModal(form, 'question')">
                                {{ form.question_text || 'click to type question...' }}
                            </div>
                            <textarea v-model="form.question_text" class="hidden-textarea"></textarea>
                        </div>

                        <div class="field-row">
                            <div class="field"><label>Score</label><input type="number" v-model.number="form.score"></div>
                            <div class="field"><label>Type</label><select v-model="form.question_type"><option value="mcq">MCQ</option><option value="true_false">True/False</option></select></div>
                            <div class="field"><label>Mandatory</label><select v-model="form.is_mandatory"><option value="1">Yes</option><option value="0">No</option></select></div>
                            <div class="field"><label>Q.status</label><select v-model="form.question_status"><option value="draft">draft</option><option value="active">active</option><option value="inactive">inactive</option><option value="archived">archived</option></select></div>
                        </div>

                        <!-- options -->
                        <div class="options-title">üîπ 4 options ¬∑ click text to expand</div>
                        <div class="options-grid">
                            <div v-for="(opt, idx) in form.options" :key="opt.id" class="option-row">
                                <span class="opt-index">{{ idx+1 }}</span>
                                <div class="opt-preview" :class="{ empty: !opt.text }" @click="openModal(opt, idx)">
                                    {{ opt.text || 'click to type...' }}
                                </div>
                                <label class="correct-toggle">
                                    <input type="radio" :value="idx" v-model="correctIndex"> correct
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn-save">üíæ SAVE QUESTION</button>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn cancel" @click="closeBuilderModal">Cancel</button>
                </div>
            </div>
        </div>

        <!-- MODAL for option editing (nested inside builder) -->
        <div v-if="modalActive" class="modal-overlay" @click.self="closeModal">
            <div class="modal-card" style="width:600px;">
                <h3><span>üìù Option {{ modalIndex + 1 }}</span></h3>
                <textarea ref="modalTextarea" v-model="modalBuffer" placeholder="Enter long option text..." rows="6"></textarea>
                <div class="modal-actions">
                    <button class="modal-btn cancel" @click="closeModal">Cancel</button>
                    <button class="modal-btn save" @click="saveModal">Save text</button>
                </div>
            </div>
        </div>

        <!-- MODAL for question editing/viewing (nested) -->
        <div v-if="questionModalActive" class="modal-overlay" @click.self="closeQuestionModal">
            <div class="modal-card" style="width:650px;">
                <h3><span>üìå Question</span></h3>
                <textarea v-model="questionModalBuffer" placeholder="Full question text" rows="6"></textarea>
                <div class="modal-actions">
                    <button class="modal-btn cancel" @click="closeQuestionModal">Close</button>
                    <button v-if="questionModalTarget === 'question'" class="modal-btn save" @click="saveQuestionFromModal">Update</button>
                </div>
            </div>
        </div>

        <!-- IMPORT MODAL -->
        <div v-if="importModalActive" class="modal-overlay" @click.self="closeImportModal">
            <div class="modal-card">
                <h3><span>üì§ Import questions</span></h3>
                <p style="background:#eef5fc; padding:16px; border-radius:40px;">Format: Code|Name|Year|Text|Score|Type|Mandatory|Status|Opt1|Opt2|Opt3|Opt4|CorrectIdx</p>
                <textarea v-model="importBuffer" placeholder="Paste multiple lines..." rows="8"></textarea>
                <div class="modal-actions">
                    <button class="modal-btn cancel" @click="closeImportModal">Cancel</button>
                    <button class="modal-btn save" @click="processImport">Import</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, reactive, ref, nextTick } = Vue;

        createApp({
            setup() {
                const showMessage = ref(false);
                const correctIndex = ref(null);

                // builder modal
                const builderModalActive = ref(false);

                // option modal (nested)
                const modalActive = ref(false);
                const modalBuffer = ref('');
                const currentOption = ref(null);
                const modalIndex = ref(0);

                // question modal (nested)
                const questionModalActive = ref(false);
                const questionModalBuffer = ref('');
                const questionModalTarget = ref('');
                const currentQuestionRef = ref(null);

                // bank expand control
                const expandedIndex = ref(null);

                // import modal
                const importModalActive = ref(false);
                const importBuffer = ref('');

                const freshOptions = () => [
                    { id: 'o1'+Date.now(), text: '' },
                    { id: 'o2'+Date.now()+1, text: '' },
                    { id: 'o3'+Date.now()+2, text: '' },
                    { id: 'o4'+Date.now()+3, text: '' }
                ];

                const form = reactive({
                    subject_code: '',
                    subject_name: '',
                    subject_status: 'draft',
                    year_id: '1',
                    question_text: '',
                    score: 1,
                    question_type: 'mcq',
                    is_mandatory: '1',
                    question_status: 'draft',
                    created_by: 1,
                    options: freshOptions()
                });

                const questionList = reactive([]);

                const currentDate = new Date().toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });

                // Builder modal
                function openBuilderModal() {
                    // Reset form for new question (unless editing sets it)
                    if (!currentQuestionRef.value) {
                        form.subject_code = '';
                        form.subject_name = '';
                        form.subject_status = 'draft';
                        form.year_id = '1';
                        form.question_text = '';
                        form.score = 1;
                        form.question_type = 'mcq';
                        form.is_mandatory = '1';
                        form.question_status = 'draft';
                        form.options = freshOptions();
                        correctIndex.value = null;
                    }
                    builderModalActive.value = true;
                }
                function closeBuilderModal() { 
                    builderModalActive.value = false;
                    currentQuestionRef.value = null; // reset edit reference
                }

                // Option modal
                function openModal(opt, idx) {
                    currentOption.value = opt;
                    modalIndex.value = idx;
                    modalBuffer.value = opt.text || '';
                    modalActive.value = true;
                    nextTick(() => {
                        const ta = document.querySelector('.modal-card textarea');
                        if (ta) ta.focus();
                    });
                }
                function closeModal() { modalActive.value = false; currentOption.value = null; }
                function saveModal() { if (currentOption.value) currentOption.value.text = modalBuffer.value; closeModal(); }

                // Question modal (for large question text)
                function openQuestionModal(source, type) {
                    questionModalBuffer.value = source.question_text;
                    currentQuestionRef.value = source;
                    questionModalTarget.value = type;
                    questionModalActive.value = true;
                }
                function closeQuestionModal() { questionModalActive.value = false; currentQuestionRef.value = null; }
                function saveQuestionFromModal() {
                    if (currentQuestionRef.value && questionModalTarget.value === 'question') {
                        currentQuestionRef.value.question_text = questionModalBuffer.value;
                    }
                    closeQuestionModal();
                }

                // Bank functions
                function toggleExpand(idx) {
                    expandedIndex.value = expandedIndex.value === idx ? null : idx;
                }

                function editFromBank(index) {
                    const q = questionList[index];
                    form.subject_code = q.subject_code;
                    form.subject_name = q.subject_name;
                    form.subject_status = q.subject_status || 'draft';
                    form.year_id = q.year_id;
                    form.question_text = q.question_text;
                    form.score = q.score;
                    form.question_type = q.question_type;
                    form.is_mandatory = q.is_mandatory;
                    form.question_status = q.question_status;
                    form.options = q.options.map(opt => ({ id: 'edit'+Math.random(), text: opt.text }));
                    while (form.options.length < 4) form.options.push({ id: 'pad'+Math.random(), text: '' });
                    if (form.options.length > 4) form.options = form.options.slice(0,4);
                    correctIndex.value = q.options.findIndex(opt => opt.is_correct === 1);
                    questionList.splice(index, 1);
                    // Open builder modal with loaded question
                    builderModalActive.value = true;
                }

                function deleteFromBank(index) {
                    if (confirm('Delete this question?')) {
                        questionList.splice(index, 1);
                        if (expandedIndex.value === index) expandedIndex.value = null;
                    }
                }

                // Import modal
                function openImportModal() { importBuffer.value = ''; importModalActive.value = true; }
                function closeImportModal() { importModalActive.value = false; }
                function processImport() {
                    const lines = importBuffer.value.split('\n').filter(l => l.trim() !== '');
                    let importedCount = 0;
                    for (let line of lines) {
                        const parts = line.split('|').map(s => s.trim());
                        if (parts.length < 13) continue;
                        try {
                            const [code, name, year, qText, scoreStr, qType, mandatory, qStatus, opt1, opt2, opt3, opt4, correctIdxStr] = parts;
                            const correctIdx = parseInt(correctIdxStr);
                            if (isNaN(correctIdx) || correctIdx < 0 || correctIdx > 3) continue;
                            const newQ = {
                                subject_code: code,
                                subject_name: name,
                                subject_status: 'active',
                                year_id: year,
                                question_text: qText,
                                score: parseFloat(scoreStr) || 1,
                                question_type: qType,
                                is_mandatory: mandatory,
                                question_status: qStatus,
                                options: [
                                    { order:1, text:opt1, is_correct: correctIdx===0?1:0 },
                                    { order:2, text:opt2, is_correct: correctIdx===1?1:0 },
                                    { order:3, text:opt3, is_correct: correctIdx===2?1:0 },
                                    { order:4, text:opt4, is_correct: correctIdx===3?1:0 }
                                ]
                            };
                            questionList.push(newQ);
                            importedCount++;
                        } catch (e) { continue; }
                    }
                    closeImportModal();
                    alert(importedCount ? `‚úÖ Imported ${importedCount} question(s).` : 'No valid questions.');
                }

                // Submit form (save from builder)
                function submitForm() {
                    if (form.options.length !== 4) { alert('Exactly 4 options required'); return; }
                    if (correctIndex.value === null || correctIndex.value < 0 || correctIndex.value > 3) {
                        alert('Please select correct answer'); return;
                    }
                    if (form.options.some(o => o.text.trim() === '')) {
                        alert('All four options must have text'); return;
                    }
                    if (!form.subject_code || !form.subject_name || !form.question_text) {
                        alert('Fill subject code, name and question'); return;
                    }

                    const savedOptions = form.options.map((opt, idx) => ({
                        order: idx+1,
                        text: opt.text,
                        is_correct: idx === correctIndex.value ? 1 : 0
                    }));

                    const newQ = {
                        subject_code: form.subject_code,
                        subject_name: form.subject_name,
                        subject_status: form.subject_status,
                        year_id: form.year_id,
                        question_text: form.question_text,
                        score: form.score,
                        question_type: form.question_type,
                        is_mandatory: form.is_mandatory,
                        question_status: form.question_status,
                        options: savedOptions
                    };
                    questionList.push(newQ);

                    // Close builder and reset
                    closeBuilderModal();
                    form.subject_code = ''; form.subject_name = ''; form.subject_status = 'draft';
                    form.year_id = '1'; form.question_text = ''; form.score = 1;
                    form.question_type = 'mcq'; form.is_mandatory = '1'; form.question_status = 'draft';
                    form.options = freshOptions();
                    correctIndex.value = null;
                }

                return {
                    form, correctIndex, questionList, currentDate,
                    builderModalActive, openBuilderModal, closeBuilderModal,
                    modalActive, modalBuffer, modalIndex, openModal, closeModal, saveModal,
                    questionModalActive, questionModalBuffer, questionModalTarget,
                    openQuestionModal, closeQuestionModal, saveQuestionFromModal,
                    expandedIndex, toggleExpand, editFromBank, deleteFromBank,
                    importModalActive, importBuffer, openImportModal, closeImportModal, processImport,
                    submitForm
                };
            }
        }).mount('#app');
    </script>
</body>
</html>